<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EagleLegal Assistant</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { primary: "#3366ff" },
          fontFamily: { display: ["Manrope", "sans-serif"] },
          borderRadius: { DEFAULT: "1.5rem" },
        },
      },
    };
  </script>

  <!-- Marked.js -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    // Enable GitHub Flavored Markdown
    marked.setOptions({
      gfm: true,
      breaks: true,
      headerIds: true,
      mangle: false,
      smartLists: true,
      smartypants: true
    });
  </script>

  <style>
    body {
      font-family: 'Manrope', sans-serif;
      background-color: #f9fafb;
      color: #111827;
    }
    .material-symbols-outlined {
      font-variation-settings:
        'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
    .dot-flashing {
      position: relative;
      width: 10px;
      height: 10px;
      border-radius: 5px;
      background-color: #3366ff;
      animation: dotFlashing 1s infinite linear alternate;
      animation-delay: 0.5s;
    }
    .dot-flashing::before, .dot-flashing::after {
      content: "";
      display: inline-block;
      position: absolute;
      top: 0;
    }
    .dot-flashing::before { left: -15px; animation-delay: 0s; }
    .dot-flashing::after { left: 15px; animation-delay: 1s; }
    @keyframes dotFlashing {
      0% { background-color: #3366ff; }
      50%,100% { background-color: rgba(51,102,255,0.2); }
    }

    /* Markdown styling */
    .markdown-content h1, .markdown-content h2, .markdown-content h3 {
      font-weight: 700;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
    }
    .markdown-content p {
      margin-bottom: 0.5rem;
    }
    .markdown-content ul {
      margin-left: 1.25rem;
      margin-bottom: 0.5rem;
      list-style-type: disc;
    }
    .markdown-content li {
      margin-bottom: 0.25rem;
    }
    .markdown-content strong {
      font-weight: 700;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 font-display antialiased">
  <img src="assets/bg.png" alt="" class="fixed inset-0 w-full h-full object-cover -z-10">

  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="w-full p-4 bg-white bg-opacity-70 backdrop-blur border-b border-gray-200">
      <div class="flex justify-between items-center max-w-4xl mx-auto">
        <span class="text-xl font-bold text-primary">EagleLegal</span>
      </div>
    </header>

    <!-- Main -->
    <main class="flex-1 flex flex-col items-center p-4 overflow-hidden">
      <div class="w-full max-w-2xl flex flex-col bg-white/70 backdrop-blur rounded-3xl shadow-md border border-gray-100 overflow-hidden">
        <div id="chat-box" class="flex-1 overflow-y-auto p-6 space-y-4 h-[70vh] markdown-content">
          <!-- Messages will appear here -->
        </div>

        <form id="chat-form" class="p-4 border-t border-gray-200 flex items-center bg-white/60 backdrop-blur">
          <input id="user-input" type="text" placeholder="Ask me anything..." 
                 class="flex-1 px-4 py-3 rounded-full bg-gray-100 border-none focus:ring-2 focus:ring-primary focus:outline-none" required/>
          <button type="submit" 
                  class="ml-3 w-10 h-10 bg-primary text-white rounded-full flex items-center justify-center hover:bg-blue-700 transition-colors">
            <span class="material-symbols-outlined text-lg">arrow_upward</span>
          </button>
        </form>
      </div>
    </main>
  </div>

  <script>
    const chatBox = document.getElementById("chat-box");
    const form = document.getElementById("chat-form");
    const userInput = document.getElementById("user-input");

    // Load chat history
    let chatHistory = JSON.parse(localStorage.getItem("chatHistory") || "[]");
    chatHistory.forEach(m => addMessage(m.text, m.sender));

    function addMessage(text, sender = "user") {
      const div = document.createElement("div");
      div.className = `flex ${sender === "user" ? "justify-end" : "justify-start"}`;

      let content = sender === "ai" ? marked.parse(text) : text;

      // Wrap content in styled bubble
      const bubble = document.createElement("div");
      bubble.className = `
        max-w-[80%] px-4 py-3 rounded-2xl text-sm leading-relaxed shadow-sm
        ${sender === "user" ? "bg-primary text-white rounded-br-none" : "bg-gray-100 text-gray-800 rounded-bl-none"}
      `;
      bubble.innerHTML = content;

      div.appendChild(bubble);
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;

      // Save message
      chatHistory.push({ text, sender });
      localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
    }

    function addTyping() {
      const div = document.createElement("div");
      div.id = "typing-indicator";
      div.className = "flex justify-start";
      div.innerHTML = `<div class="bg-gray-100 px-4 py-3 rounded-2xl rounded-bl-none shadow-sm"><div class="dot-flashing"></div></div>`;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function removeTyping() {
      const typingDiv = document.getElementById("typing-indicator");
      if (typingDiv) typingDiv.remove();
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const query = userInput.value.trim();
      if (!query) return;

      addMessage(query, "user");
      userInput.value = "";
      addTyping();

      try {
        const response = await fetch("/infer", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query }),
        });
        const data = await response.json();
        removeTyping();

        if (data.answer) addMessage(data.answer, "ai");
        else addMessage("⚠️ Sorry, I couldn’t generate a response.", "ai");
      } catch (err) {
        removeTyping();
        addMessage("❌ Error connecting to server.", "ai");
      }
    });
  </script>
</body>
</html>
